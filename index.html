<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NetSuite FSM Job Parser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #f9fafb;
      padding: 20px;
      line-height: 1.5;
      max-width: 960px;
      margin: 0 auto;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    .card {
      background: #1f2937;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 14px;
      font-size: 14px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    button.secondary {
      background: #4b5563;
    }
    button.outline {
      background: transparent;
      border: 1px solid #4b5563;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    textarea {
      width: 100%;
      height: 220px;
      background: #020617;
      color: #f9fafb;
      border: 1px solid #374151;
      border-radius: 6px;
      padding: 10px;
      font-size: 13px;
      resize: vertical;
      box-sizing: border-box;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
      font-family: inherit;
      font-size: 13px;
    }
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid #4b5563;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
    }
    .tab.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #f9fafb;
    }
    .label {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #111827;
      color: #e5e7eb;
      font-size: 11px;
      border: 1px solid #374151;
      margin-left: 8px;
    }
    .field-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 2fr);
      gap: 6px 12px;
    }
    .field-label {
      font-weight: 600;
      font-size: 13px;
    }
    .field-value {
      font-size: 13px;
      color: #e5e7eb;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .error {
      color: #fca5a5;
      font-size: 13px;
    }
    @media (max-width: 640px) {
      .field-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <h1>NetSuite FSM Job Parser</h1>
  <p>
    Data is sent here from your bookmarklet. Install this page as an app (PWA) for offline use,
    or just open it directly when needed.
  </p>

  <div class="card" id="statusCard">
    <h3>Status</h3>
    <p id="statusText">Waiting for data&hellip;</p>
    <p id="errorText" class="error" style="display:none;"></p>
  </div>

  <div class="card" id="summaryCard" style="display:none;">
    <h3>
      Job Fields
      <span class="badge" id="idBadge"></span>
    </h3>
    <div class="field-grid" id="fieldGrid"></div>
  </div>

  <div class="card">
    <h3>Output</h3>
    <div class="tabs">
      <button class="tab active" data-mode="text">Text</button>
      <button class="tab" data-mode="markdown">Markdown</button>
      <button class="tab" data-mode="csv">CSV</button>
      <button class="tab" data-mode="json">JSON</button>
    </div>
    <div class="row">
      <button id="copyCurrent">Copy current view</button>
      <button id="downloadTxt" class="secondary">Save .txt</button>
      <button id="downloadMd" class="secondary">Save .md</button>
      <button id="downloadCsv" class="secondary">Save .csv</button>
      <button id="downloadJson" class="secondary">Save .json</button>
    </div>
    <div class="label" id="modeLabel">Text summary</div>
    <textarea id="outputArea" readonly></textarea>
  </div>

  <div class="card">
    <h3>Shared data / Debug</h3>
    <p class="label">If you share a page to the installed PWA, its URL/text will appear here.</p>
    <textarea id="sharedArea" readonly></textarea>
  </div>

  <script>
    // --- util helpers ---
    function mdCell(v) {
      return (v || "").toString().replace(/\r?\n/g, "<br>").replace(/\|/g, "\\|");
    }
    function buildMarkdown(d) {
      const today = new Date().toLocaleDateString("en-AU");
      return (
        "# Job Summary – " + mdCell(d.caseNum) + " (" + mdCell(d.woNum) + ")\n\n" +
        "**Date:** " + today + "\n\n" +
        "---\n\n" +
        "## Job Information\n\n" +
        "| Field | Value |\n" +
        "|------|-------|\n" +
        "| Site | " + mdCell(d.site) + " |\n" +
        "| Address | " + mdCell(d.address) + " |\n" +
        "| Case Number | " + mdCell(d.caseNum) + " |\n" +
        "| Case Type | " + mdCell(d.caseType) + " |\n" +
        "| Case Details (URL) | " + mdCell(d.caseDetails) + " |\n" +
        "| Task Number | " + mdCell(d.taskNum) + " |\n" +
        "| Task Type | " + mdCell(d.taskType) + " |\n" +
        "| WO # | " + mdCell(d.woNum) + " |\n" +
        "| Scheduled Window | " + mdCell(d.scheduledWindow) + " |\n" +
        "| Date/Time Issued | " + mdCell(d.issuedDate) + " |\n" +
        "| Complete OverDue Date | " + mdCell(d.completeDue) + " |\n" +
        "| Task Details | " + mdCell(d.description) + " |\n" +
        "| Equipment | " + mdCell(d.equipment) + " |\n"
      );
    }
    function buildText(d) {
      const today = new Date().toLocaleDateString("en-AU");
      return [
        "Date: " + today,
        "Case Number: " + (d.caseNum || ""),
        "Case Type: " + (d.caseType || ""),
        "Task Number: " + (d.taskNum || ""),
        "Task Type: " + (d.taskType || ""),
        "WO Number: " + (d.woNum || ""),
        "Site: " + (d.site || ""),
        "Address: " + (d.address || ""),
        "Scheduled Window: " + (d.scheduledWindow || ""),
        "Issued: " + (d.issuedDate || ""),
        "Overdue Date: " + (d.completeDue || ""),
        "Case Details URL: " + (d.caseDetails || ""),
        "Equipment: " + (d.equipment || ""),
        "",
        "Task Details:",
        d.description || ""
      ].join("\\n");
    }
    function csvCell(v) {
      const s = (v || "").toString().replace(/\\r?\\n/g, " ");
      if (/[",]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }
    function buildCsv(d) {
      const rows = [
        ["Field", "Value"],
        ["Site", d.site],
        ["Address", d.address],
        ["Case Number", d.caseNum],
        ["Case Type", d.caseType],
        ["Case Details URL", d.caseDetails],
        ["Task Number", d.taskNum],
        ["Task Type", d.taskType],
        ["WO Number", d.woNum],
        ["Scheduled Window", d.scheduledWindow],
        ["Issued Date", d.issuedDate],
        ["Overdue Date", d.completeDue],
        ["Equipment", d.equipment],
        ["Task Details", d.description]
      ];
      return rows.map(r => r.map(csvCell).join(",")).join("\\n");
    }
    function downloadFile(filename, content, mime) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function safeFilePart(str) {
      return (str || "")
        .toString()
        .replace(/[^a-z0-9_-]+/gi, "_")
        .replace(/^_+|_+$/g, "")
        .slice(0, 40) || "job";
    }

    const statusText = document.getElementById("statusText");
    const errorText = document.getElementById("errorText");
    const summaryCard = document.getElementById("summaryCard");
    const fieldGrid = document.getElementById("fieldGrid");
    const idBadge = document.getElementById("idBadge");
    const outputArea = document.getElementById("outputArea");
    const sharedArea = document.getElementById("sharedArea");
    const modeLabel = document.getElementById("modeLabel");
    const tabs = Array.from(document.querySelectorAll(".tab"));

    let currentData = null;
    let currentMode = "text";

    function renderSharedInfo() {
      const params = new URLSearchParams(window.location.search);
      const sharedTitle = params.get("title") || "";
      const sharedText = params.get("text") || "";
      const sharedUrl = params.get("url") || "";
      const parts = [];
      if (sharedTitle) parts.push("Shared title: " + sharedTitle);
      if (sharedText) parts.push("Shared text: " + sharedText);
      if (sharedUrl) parts.push("Shared URL: " + sharedUrl);
      sharedArea.value = parts.join("\\n") || "No shared data. If you install this as an app (PWA) and share a page to it, the shared title/text/URL will appear here.";
    }

    function renderFields(data) {
      fieldGrid.innerHTML = "";
      const fields = [
        ["Case Number", data.caseNum],
        ["Case Type", data.caseType],
        ["Task Number", data.taskNum],
        ["Task Type", data.taskType],
        ["WO Number", data.woNum],
        ["Site", data.site],
        ["Address", data.address],
        ["Scheduled Window", data.scheduledWindow],
        ["Issued Date", data.issuedDate],
        ["Overdue Date", data.completeDue],
        ["Case Details URL", data.caseDetails],
        ["Equipment", data.equipment],
        ["Task Details", data.description]
      ];
      fields.forEach(([label, value]) => {
        const lbl = document.createElement("div");
        lbl.className = "field-label";
        lbl.textContent = label;
        const val = document.createElement("div");
        val.className = "field-value";
        val.textContent = value || "";
        fieldGrid.appendChild(lbl);
        fieldGrid.appendChild(val);
      });

      const idPieces = [];
      if (data.caseNum) idPieces.push("Case " + data.caseNum);
      if (data.taskNum) idPieces.push("Task " + data.taskNum);
      if (data.woNum) idPieces.push("WO " + data.woNum);
      idBadge.textContent = idPieces.join("  •  ") || "No IDs found";
    }

    function updateOutput() {
      if (!currentData) {
        outputArea.value = "";
        document.getElementById("copyCurrent").disabled = true;
        document.getElementById("downloadTxt").disabled = true;
        document.getElementById("downloadMd").disabled = true;
        document.getElementById("downloadCsv").disabled = true;
        document.getElementById("downloadJson").disabled = true;
        return;
      }
      document.getElementById("copyCurrent").disabled = false;
      document.getElementById("downloadTxt").disabled = false;
      document.getElementById("downloadMd").disabled = false;
      document.getElementById("downloadCsv").disabled = false;
      document.getElementById("downloadJson").disabled = false;

      let content = "";
      if (currentMode === "text") {
        content = buildText(currentData);
        modeLabel.textContent = "Text summary";
      } else if (currentMode === "markdown") {
        content = buildMarkdown(currentData);
        modeLabel.textContent = "Markdown summary";
      } else if (currentMode === "csv") {
        content = buildCsv(currentData);
        modeLabel.textContent = "CSV export";
      } else if (currentMode === "json") {
        content = JSON.stringify(currentData, null, 2);
        modeLabel.textContent = "Raw job JSON";
      }
      outputArea.value = content;
    }

    function setMode(mode) {
      currentMode = mode;
      tabs.forEach(t => t.classList.toggle("active", t.dataset.mode === mode));
      updateOutput();
    }

    tabs.forEach(tab => {
      tab.addEventListener("click", () => setMode(tab.dataset.mode));
    });

    document.getElementById("copyCurrent").addEventListener("click", () => {
      if (!outputArea.value) return;
      navigator.clipboard.writeText(outputArea.value);
    });

    document.getElementById("downloadTxt").addEventListener("click", () => {
      if (!currentData) return;
      const base = safeFilePart(currentData.caseNum || currentData.taskNum || currentData.woNum);
      downloadFile(base + ".txt", buildText(currentData), "text/plain");
    });
    document.getElementById("downloadMd").addEventListener("click", () => {
      if (!currentData) return;
      const base = safeFilePart(currentData.caseNum || currentData.taskNum || currentData.woNum);
      downloadFile(base + ".md", buildMarkdown(currentData), "text/markdown");
    });
    document.getElementById("downloadCsv").addEventListener("click", () => {
      if (!currentData) return;
      const base = safeFilePart(currentData.caseNum || currentData.taskNum || currentData.woNum);
      downloadFile(base + ".csv", buildCsv(currentData), "text/csv");
    });
    document.getElementById("downloadJson").addEventListener("click", () => {
      if (!currentData) return;
      const base = safeFilePart(currentData.caseNum || currentData.taskNum || currentData.woNum);
      downloadFile(base + ".json", JSON.stringify(currentData, null, 2), "application/json");
    });

    function initFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get("d");
      if (!raw) {
        statusText.textContent = "No job payload (?d=...) detected. Launch this page via the bookmarklet or share target for it to auto-populate.";
        return;
      }
      try {
        const data = JSON.parse(decodeURIComponent(raw));
        currentData = data;
        statusText.textContent = "Job data loaded.";
        errorText.style.display = "none";
        summaryCard.style.display = "block";
        renderFields(data);
        setMode("text");
      } catch (err) {
        console.error(err);
        statusText.textContent = "Failed to parse job data.";
        errorText.style.display = "block";
        errorText.textContent = "Error: " + err.message;
      }
    }

    renderSharedInfo();
    initFromQuery();

    // PWA: register service worker (ignore failures quietly)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(() => {});
    }
  </script>
</body>
</html>
